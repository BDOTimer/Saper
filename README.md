TODO:

Если это работает так как нужно по основным подзадачам,
то остнанавливаемся и из этого исходника гернерим говнокод:
вытаскиваем фанки из структур.
